---
title: "値オブジェクトとは"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [ドメイン駆動設計]
published: false
---

> ドメイン駆動設計のコンセプトは、ビジネスの問題を解決するためにビジネスの理解を深め、ビジネスの表現する。ビジネスとコードを結びつけて継続的かつ反復的な改良を施せるような枠組みを作ることにより、ソフトウェアをより役立つものにしようというものです。
（成瀬 2022、p4）


# はじめに

値オブジェクトについて、整理するためにこの記事を書く。

# 前提知識

ドメイン駆動設計には、「アプリケーションを実現するためのパターン」と「ドメインの知識を表現するためのパターン」の2つが存在する。それぞれ、以下のような関係性がある。

```mermaid
flowchart LR
    アプリケーションを\n実現するためのパターン-- 利用する -->ドメインの知識を\n表現するためのパターン
```

# 値オブジェクトの立ち位置

「値オブジェクト」は、「ドメインの知識を表現するパターン」として使われる。

「ドメインの知識を表現するパターン」には、「値オブジェクト」の他に、「集約」「ドメインサービス」「エンティティ」「仕様」と呼ばれるパターンがある。

「値オブジェクト」は、その中で基本のパターンとして扱われている。

# 値オブジェクトとは

値オブジェクトは、値の性質である「**不変**」「**交換可能**」「**等価性による比較**」をオブジェクトに適用することで、以下の効果をコードにもたらし、「システム固有の値」を作ることを期待されている

- 表現力の増加
- 不正な値を存在させない
- 誤った代入を防ぐ
- ロジックの散財の防ぐ

# 「値」と「値オブジェクト」の違い

コードで書くと、以下の違いになる。

```c#:値
var fullName = "uzumaki naruto"
```

```c#:値オブジェクト
class FullName
[
    public FullName(string firstName, string lastName)
    {
        FirstName = firstName;
        LastName = lastName;
    }

    public string FirstName { get }
    public string LastName { get }
]
```

値はプリミティブ型で、値オブジェクトはクラスである、と言いたいわけではない。

値は、「姓」と「名」に、前後関係、依存性をもたらし、値オブジェクトは並列関係、独立性をもたらすことが言いたい。

並列関係にすることで、「姓」と「名」を同等に扱うことができ、呼び出しがシンプルになる、かつ、仕様変更にも対応しやすい。（この場合だと、外国人の名前の対応がわかりやすい）


```c#:値の「姓」のみを呼び出す時
var fullName = "uzumaki naruto"
var tokens = fullName.Split{" "}
var lastName = tokens[0]
Console.WirteLine(lastName)
```

```c#:値オブジェクトの「姓」のみを呼び出す時
var fullName = new FullName("uzumaki","naruto")
Console.WirteLine(fullName.LastName)
```

# 値の性質を値オブジェクトに適用する

値には、以下の3つの性質がある。この性質は、値オブジェクトに適用するので、抑えるべき。
- 不変である
- 交換が可能である
- 等価性によって比較される

### 不変である

そのままの意味である。"Hello"は、"こんにちは"ではない。0は1ではない。
この性質を値オブジェクトに適用すると、以下のコードはNGになる。
なぜなら、不変であるべき値オブジェクトに自身の値を変更させるメソッドを定義しているからだ。

```c#:値オブジェクトのNGコード
var fullName = new FullName("uzumaki","naruto")
fullName.ChangeLastName("namikaze")
```

不変のメリットとデメリットは以下の通りだ

- メリット
  - キャッシュの再利用、並行・並列処理が容易になる
- デメリット
  - 値を一部変更させると、新たなインスタンスを生成する必要がある。つまり、パフォーマンス的に悪い。


### 交換が可能である

値オブジェクトは不変であるべきだが、現実問題厳しいときがある。
その場合は、代入で見せかけの「値の変更」をおこなうことは可能になっている。

```c#:値オブジェクトの変更方法
var fullName = new FullName("uzumaki","naruto")
fullName = new FullName("namikaze", "naruto")
```

### 等価性によって比較される
- 比較は、値の属性によって比較される。
- 値オブジェクトを値として扱う
- 値オブジェクトを比較するためのメソッドが必要
- 値オブジェクトの属性を比較することが必要
- 等価性のパターンがある

## 値オブジェクトにする基準

葛藤がある「やりすぎ」か「正しいか」
- ルールが存在しているか、もしくは単体で取り扱いたいか
- 値オブジェクトを避けることではありません。値オブジェクトにすべきかどうかを見極めて、そうすべきと判断したのであれば、大胆に実行すべき
- ドメイン駆動の目的は、いてレーティブで気付きを得ることが価値

## ふるまいを持った値オブジェクト
- 「ふるまい」と「値の変更」の違い
- 誤った操作があるのであれば、防止すべき
- オブジェクトができる振る舞いとできない振る舞いを見極める必要がある（例：お金は加算できるが、乗算はできないなど）

## 値オブジェクトを採用するモチベーション

- コードは適切な大きさに細分化し、分散すべき
- 表現力を増す
- 不正な値を存在させない
  - ルールの箇所を1箇所にまとめることができる（共通化）
- 誤った代入を防ぐ
　- 型で誤った代入を防ぐことができる
- ロジックの散財を防ぐ
  - DIY原則
    - 重複を防ぐことw
    - 値

## 参考

- [成瀬允宣（2020）「ドメイン駆動設計入門 ボトムアップでわかる! ドメイン駆動設計の基本」、翔泳社](https://www.amazon.co.jp/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E9%A7%86%E5%8B%95%E8%A8%AD%E8%A8%88%E5%85%A5%E9%96%80-%E3%83%9C%E3%83%88%E3%83%A0%E3%82%A2%E3%83%83%E3%83%97%E3%81%A7%E3%82%8F%E3%81%8B%E3%82%8B-%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E9%A7%86%E5%8B%95%E8%A8%AD%E8%A8%88%E3%81%AE%E5%9F%BA%E6%9C%AC-%E6%88%90%E7%80%AC-%E5%85%81%E5%AE%A3/dp/479815072X)